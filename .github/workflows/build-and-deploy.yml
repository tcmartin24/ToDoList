name: Build and Push Docker Images

on:
  push:
    branches:
      - main
      - dockerized

env:
  ACR_NAME: ${{ secrets.ACR_NAME }}
  ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Log in to Azure Container Registry
        run: |
          az acr login --name ${{ env.ACR_NAME }}

      - name: Verify Docker tag format
        run: |
          echo "Tag format check: $(echo ${ACR_LOGIN_SERVER}/todolist-api:latest | sed 's/[^\/]*\//***\//g')"
          echo "Tag format with run ID: $(echo ${ACR_LOGIN_SERVER}/todolist-api:${{ github.run_id }} | sed 's/[^\/]*\//***\//g')"
          
      - name: Debug Docker build command
        run: |
          echo "ACR_LOGIN_SERVER is set: ${{ env.ACR_LOGIN_SERVER != '' }}"
          echo "First part of ACR_LOGIN_SERVER: ${ACR_LOGIN_SERVER%%.*}"
          echo "Docker build command: docker build -t \${ACR_LOGIN_SERVER}/todolist-api:latest -t \${ACR_LOGIN_SERVER}/todolist-api:\${GITHUB_RUN_ID} -f **/ToDoList-API/Dockerfile ."
          
      - name: List directory contents
        run: |
          echo "Current directory:"
          pwd
          echo "Contents of current directory:"
          ls -R
          echo "Looking for Dockerfile:"
          find . -name Dockerfile
          
      - name: Build and push ToDoList-API Docker image
        run: |
          echo "ACR_LOGIN_SERVER: ${ACR_LOGIN_SERVER}"
          echo "Building image without tag first..."
          docker build -f ./ToDoList-API/Dockerfile .
          echo "Docker build command exit code: $?"
          echo "ACR_LOGIN_SERVER: ${ACR_LOGIN_SERVER}"
          echo "Building image without tag first..."
          docker build -f **/ToDoList-API/Dockerfile .
          echo "Docker build command exit code: $?"
          echo "Now trying to tag the image..."
          docker tag $(docker images -q | head -n 1) "${ACR_LOGIN_SERVER}/todolist-api:latest"
          echo "Docker tag command exit code: $?"
          docker images
          echo "Attempting to push..."
          docker push "${ACR_LOGIN_SERVER}/todolist-api:latest"
          echo "Docker push command exit code: $?"

      - name: Build and push todo-list-react Docker image
        run: |
          docker build -t ${{ env.ACR_LOGIN_SERVER }}/todo-list-react:latest -t ${{ env.ACR_LOGIN_SERVER }}/todo-list-react:${{ github.run_id }} -f **/todo-list-react/Dockerfile .
          docker push ${{ env.ACR_LOGIN_SERVER }}/todo-list-react:latest
          docker push ${{ env.ACR_LOGIN_SERVER }}/todo-list-react:${{ github.run_id }}
